<!--
  Copyright 2014 IBM Corp.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="cloudant">
    <div class="form-row">
        <label for="node-config-input-hostname"><i class="fa fa-bookmark"></i> Host</label>
        <input class="input-append-left" type="text" id="node-config-input-hostname"
               placeholder="https://[username].cloudant.com">
    </div>

    <div class="form-row">
        <label for="node-config-input-user"><i class="fa fa-user"></i> Username</label>
        <input type="text" id="node-config-input-user">
    </div>

    <div class="form-row">
        <label for="node-config-input-pass"><i class="fa fa-lock"></i> Password</label>
        <input type="password" id="node-config-input-pass">
    </div>

    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType("cloudant",{
        category: "config",
        color: "rgb(114, 199, 231)",
        defaults: {
            hostname: { value: "", required: true },
            name: { value: "" },
            //user -> credentials
            //pass -> credentials
        },
        label: function() {
            return this.name || this.hostname;
        },
        oneditprepare: function() {
            $.getJSON("cloudant/"+this.id, function(data) {
                if (data.user) {
                    $("#node-config-input-user").val(data.user);
                }
                if (data.hasPassword) {
                    $("#node-config-input-pass").val("__PWRD__");
                } else {
                    $("#node-config-input-pass").val("");
                }
            });
        },
        oneditsave: function() {
            var newUser = $("#node-config-input-user").val();
            var newPass = $("#node-config-input-pass").val();
            var credentials = {};
            credentials.user = newUser;
            if (newPass != "__PWRD__") {
                credentials.password = newPass;
            }
            $.ajax({
                url: "cloudant/"+this.id,
                type: "POST",
                data: credentials,
                success: function(result) {}
            });
        },
        ondelete: function() {
            $.ajax({
                url: "cloudant/"+this.id,
                type: "DELETE",
                success: function(result) {}
            });
        }
    });
</script>

<script type="text/x-red" data-template-name="cloudant out">
    <div class="form-row">
        <label for="node-input-service"><i class="fa fa-folder-close"></i> Service</label>
        <select id="node-input-service">
            <option value="" disabled></option>
            <option value="_ext_"> External service</option>
        </select>
    </div>

    <div class="form-row hide" id="node-input-external-details">
        <label for="node-input-cloudant"><i class=" fa fa-bookmark"></i> Server</label>
        <input type="text" id="node-input-cloudant">
    </div>

    <div class="form-row">
        <label for="node-input-database"><i class="fa fa-briefcase"></i> Database</label>
        <input type="text" id="node-input-database" placeholder="database">
    </div>

    </div>
        <div class="form-row">
        <label for="node-input-operation"><i class="fa fa-wrench"></i> Operation</label>
        <select type="text" id="node-input-operation"
                style="display: inline-block; vertical-align: top;">
            <option value="insert">insert</option>
            <option value="delete">remove</option>
        </select>
    </div>

    <div class="form-row node-input-payonly">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-payonly" placeholder="Only"
               style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-payonly" style="width: 70%;">Only store msg.payload object?</label>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <script>
        $("#node-input-operation").change(function() {
            var id = $("#node-input-operation option:selected").val();
            if (id == "delete") $(".node-input-payonly").hide();
            else $(".node-input-payonly").show();
        });
    </script>
</script>

<script type="text/javascript">
    RED.nodes.registerType("cloudant out", {
        category: "storage-output",
        color: "rgb(114, 199, 231)",
        defaults: {
            service: { value: "", required: true },
            cloudant: { type: "cloudant", validate: validateServer},
            name: { value: "" },
            database: { value: "", required: true },
            payonly: { value: false },
            operation: { value: "insert" }
        },
        inputs: 1,
        outputs: 0,
        icon: "cloudant.png",
        align: "right",
        label: label,
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: oneditprepare
    });

    function oneditprepare() {
        var select = $('#node-input-service');
        var node = this;

        $.getJSON('cloudant/vcap/',function(data) {
            var last = select.children().last();
            var opts = [];

            for (var i=0; i < data.length; i++) {
                var selected = node.service == data[i].name;
                opts.push(
                    '<option value="' + data[i].name + '"' + (selected ? " selected":"") + '>' +
                        data[i].name +
                    '</option>'
                );
            }

            if (opts.length == 0) {
                node.service = "_ext_";
                select.find("option").filter(function() {
                    return $(this).val() == node.service;
                }).attr('selected', true);
            } else {
                last.before(opts.join(""));
            }

            select.change();
        });

        select.change(function() {
            var service = select.val();
            if (service == "_ext_") {
                $("#node-input-external-details").show();
            } else {
                $("#node-input-external-details").hide();
            }
        });
    }

    function label() {
        return this.name || this.database || "cloudant";
    }

    function validateServer(v) {
        return this.service != "_ext_" || v != "_ADD_";
    }
</script>

<script type="text/x-red" data-help-name="cloudant out">
   <p>
       A simple Cloudant output node. Stores <b>msg</b> in a chosen database.
    </p>
   <p>
       Cloudant generates a random id for the <b>msg._id</b> property if one
       is not specified and a new document will be <b>inserted</b> each time.
       If you want to <b>update</b> an existing document you must specify a
       value for <b>msg._id</b> in your object.
    </p>
    <p>
        You can <b>insert</b> only the <b>payload</b> by checking the checkbox
        in the configuration window.
    </p>
    <p>
        It is also possible to <b>delete</b> documents from the database by
        providing values for <b>msg.payload._id</b> and <b>msg.payload._rev</b>
        and selecting the <b>remove</b> option for the node.
    </p>
</script>
